# HAProxy Configuration for Kafka Load Balancing
# Provides high availability and load distribution across Kafka brokers

global
    daemon
    log stdout local0 info
    maxconn 4096
    # user haproxy
    # group haproxy
    # stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout check 5s
    maxconn 2000

# Kafka Load Balancer
frontend kafka_frontend
    bind *:9095
    mode tcp
    option tcplog
    default_backend kafka_brokers

backend kafka_brokers
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Health checks for Kafka brokers
    tcp-check connect
    tcp-check send-binary 00000016001100000000000000000001000b6b61666b612d636865636b
    tcp-check expect binary 0000001e0011000000000000
    
    # Kafka broker servers
    server kafka-1 kafka-1:29092 check inter 10s rise 3 fall 2 weight 100
    server kafka-2 kafka-2:29092 check inter 10s rise 3 fall 2 weight 100
    server kafka-3 kafka-3:29092 check inter 10s rise 3 fall 2 weight 100

# Statistics and monitoring
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats admin if TRUE
    
    # Basic authentication for stats (optional)
    # stats auth admin:password
    
    # Additional stats configuration
    stats realm "HAProxy Kafka Load Balancer Statistics"
    stats hide-version
    
# Health check endpoint
listen health_check
    bind *:8405
    mode http
    monitor-uri /health
    option httpchk GET /health
    
    # Return 200 OK if at least one Kafka broker is healthy
    acl kafka_healthy nbsrv(kafka_brokers) ge 1
    monitor fail unless kafka_healthy
